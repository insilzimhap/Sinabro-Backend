<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title> ì‹œë‚˜ë¸Œë¡œ </title>
  
  <link rel="stylesheet" href="/web/css/header.css" />
  <link rel="stylesheet" href="/web/css/users/users_index.css" />
  <!-- ì¸ì¦ ê°€ë“œ ê³µìš© fetch -->
  <script src="/web/js/common.js"></script>
</head>
<body>
    <div id="header-container"></div>

  <main>
    <!-- ğŸ” ê²€ìƒ‰ UI (ë°±ì—”ë“œ ì—°ë™ì€ ì¶”í›„) -->
    <div class="member-search-container">
      <h3>íšŒì› ê²€ìƒ‰</h3>
      <div class="search-bar">
        <select id="searchField">
          <option value="parentName">ë¶€ëª¨ ì´ë¦„</option>
          <option value="childName" disabled>ìì‹ ì´ë¦„</option>
          <option value="email" disabled>ì´ë©”ì¼</option>
        </select>
        <input id="searchInput" type="text" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
        <button id="searchBtn" onclick="searchMembers()">ê²€ìƒ‰</button>
      </div>

      <!-- ëª©ë¡ ì˜ì—­ -->
      <div id="memberList" class="member-list">
<!--        <div class="member-item">-->
<!--          <div class="member-info">-->
<!--            <strong>ê¹€ì™€ì™€</strong> (mwa2day) mwa2day@gmail.com-->
<!--          </div>-->
<!--          <button onclick="location.href='users_index_parent.html'">ìƒì„¸</button>-->
<!--        </div>-->
      </div>

    </div>
  </main>

  <script>
    // ê³µí†µ í—¤ë” ë¡œë“œ + ë¡œê·¸ì¸ ìƒíƒœ í‘œì‹œ
    fetch("/web/header.html")
            .then(res => res.text())
            .then(html => {
              document.getElementById("header-container").innerHTML = html;
              // header.html ì•ˆì—ì„œ checkLogin() ì •ì˜ë˜ì–´ ìˆìŒ
              if (typeof checkLogin === "function") checkLogin();
            });

    // âœ… íšŒì› ëª©ë¡ ë¡œë“œ
    async function loadUsers() {
      try {
        const res = await apiFetch("/api/admin/users"); // ì„¸ì…˜ ì—†ìœ¼ë©´ apiFetchê°€ ë¡œê·¸ì¸ìœ¼ë¡œ ë³´ëƒ„
        if (!res) return; // apiFetchê°€ ì´ë¯¸ ì²˜ë¦¬(ë¦¬ë‹¤ì´ë ‰íŠ¸)í–ˆìŒ
        if (!res.ok) throw new Error("ëª©ë¡ í˜¸ì¶œ ì‹¤íŒ¨");

        const data = await res.json();
        renderUsers(data);
      } catch (e) {
        console.error(e);
        alert("íšŒì› ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    }

    // âœ… ëª©ë¡ ë Œë”ë§: "ì´ë¦„ (ì•„ì´ë””) ì´ë©”ì¼"
    function renderUsers(users) {
      const listEl = document.getElementById("memberList");
      listEl.innerHTML = "";

      if (!users || users.length === 0) {
        listEl.innerHTML = `<div class="member-empty">í‘œì‹œí•  íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
        return;
      }

      users.forEach(u => {
        const item = document.createElement("div");
        item.className = "member-item";

        item.innerHTML = `
          <div class="member-info">
            <strong>${escapeHtml(u.name ?? "")}</strong>
            (${escapeHtml(u.id ?? "")})
            ${escapeHtml(u.email ?? "")}
          </div>
          <button type="button" class="detail-btn">ìƒì„¸</button>
        `;

        item.querySelector(".detail-btn").addEventListener("click", () => {
          // ìƒì„¸ í˜ì´ì§€ë¡œ userId ì „ë‹¬
          window.location.href = "/web/html/users/users_index_parent.html?userId=" + encodeURIComponent(u.id);
        });

        listEl.appendChild(item);
      });
    }

    // ğŸ” ê°„ë‹¨í•œ XSS ë°©ì§€ìš© ì´ìŠ¤ì¼€ì´í”„
    function escapeHtml(str) {
      return String(str)
              .replace(/&/g, "&amp;")
              .replace(/</g, "&lt;")
              .replace(/>/g, "&gt;")
              .replace(/"/g, "&quot;")
              .replace(/'/g, "&#039;");
    }

    // ğŸ” ê²€ìƒ‰(1ì°¨: í”„ë¡ íŠ¸ í•„í„°) â€” ë°±ì—”ë“œ ì—°ë™ ì „ ì„ì‹œ
    document.getElementById("searchBtn").addEventListener("click", async () => {
      const q = document.getElementById("searchInput").value.trim().toLowerCase();
      const field = document.getElementById("searchField").value;

      // ì „ì²´ ëª©ë¡ ë¶ˆëŸ¬ì™€ì„œ í”„ë¡ íŠ¸ì—ì„œ í•„í„°
      const res = await apiFetch("/api/admin/users");
      if (!res) return;
      const all = await res.json();

      let filtered = all;
      if (q) {
        if (field === "parentName") {
          filtered = all.filter(u => (u.name || "").toLowerCase().includes(q));
        }
        // childName, emailì€ ì¶”í›„ ë°±ì—”ë“œ ê²€ìƒ‰ API ë¶™ì´ë©´ì„œ í™œì„±í™”
      }

      renderUsers(filtered);
    });

    // í˜ì´ì§€ ì²« ë¡œë“œ ì‹œ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    window.addEventListener("DOMContentLoaded", loadUsers);
  </script>
</body>
</html>
