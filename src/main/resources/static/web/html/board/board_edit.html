<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>공지사항 수정 - 시나브로</title>
  <link rel="stylesheet" href="/web/css/header.css" />
  <link rel="stylesheet" href="/web/css/board/board_edit.css" />
  <!-- 공통 fetch 유틸 -->
  <script src="/web/js/common.js"></script>
</head>
<body>
  <div id="header-container"></div>

  <main>
    <div class="container">
      <h2>공지사항 수정</h2>
      <form id="editForm">
        <div class="form-group">
          <label for="title">제목</label>
          <input type="text" id="title" required />
        </div>

        <div class="form-group">
          <label for="content">내용</label>
          <textarea id="content" required></textarea>
        </div>

        <div class="form-group">
          <label for="date">작성일</label>
          <input type="text" id="date" readonly />
        </div>

        <div class="form-group">
          <label for="type">유형</label>
          <input type="text" id="type"/>
        </div>

        <div class="button-row">
          <button type="submit" class="save-btn">저장하기</button>
          <button type="button" class="cancel-btn" onclick="location.href='board_notice.html'">취소하기</button>
        </div>
      </form>
    </div>
  </main>

  <script>
    // 공통 헤더 삽입
    fetch("/web/header.html")
      .then(res => res.text())
      .then(data => {
        document.getElementById("header-container").innerHTML = data;
        checkLogin(); // 헤더 붙인 뒤 호출!
      });

    const API_BASE = "http://localhost:8090/api/admin/notices";

    // yyyy-MM-dd로 변환
    function formatDate(iso) {
      if (!iso) return "";
      try { return iso.split("T")[0]; } catch { return ""; }
    }

    // URL ?id= 추출
    const params = new URLSearchParams(window.location.search);
    const noticeId = params.get("id");

    if (!noticeId) {
      alert("잘못된 접근입니다. 공지 ID가 없습니다.");
      location.replace("board_notice.html");
    }

    // 초기 데이터 로드 (상세 조회)
    async function loadDetail() {
      try {
        const res = await fetch(`${API_BASE}/${noticeId}`);
        if (!res.ok) throw new Error("공지사항을 불러오지 못했습니다.");

        const n = await res.json();
        // 폼 채우기
        document.getElementById("title").value = n.title || "";
        document.getElementById("content").value = n.content || "";
        document.getElementById("type").value = n.noticeType || "";
        document.getElementById("date").value = formatDate(n.createdDate);
      } catch (e) {
        console.error(e);
        alert("공지사항 정보를 불러오는 중 오류가 발생했습니다.");
        location.replace("board_notice.html");
      }
    }

    // 저장(수정) 처리
    document.getElementById("editForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const payload = {
        title: document.getElementById("title").value.trim(),
        content: document.getElementById("content").value.trim(),
        noticeType: document.getElementById("type").value.trim()
      };

      if (!payload.title || !payload.content) {
        alert("제목과 내용을 입력해주세요.");
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/${noticeId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error("수정 실패");

        alert("공지사항이 수정되었습니다.");
        // 수정 후 목록으로 이동 (원하면 상세로 이동해도 됨)
        location.href = "board_notice.html";
      } catch (e) {
        console.error(e);
        alert("수정 중 오류가 발생했습니다.");
      }
    });

    // 페이지 로드 시점
    document.addEventListener("DOMContentLoaded", loadDetail);
  </script>
</body>
</html>
